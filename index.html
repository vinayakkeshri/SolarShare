<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SolarShare — Frontend</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{--accent:#0d6f3a}
    body{padding-top:70px;background:#f7faf7}
    #map{height:420px;border-radius:8px}
    .card{box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .muted{color:#6b7280}
    .chip{display:inline-block;padding:4px 10px;border-radius:20px;background:#eef6ee;color:var(--accent);font-weight:600}
    .small-muted{font-size:.85rem;color:#6b7280}
    .form-note{font-size:.85rem;color:#374151}
  </style>
</head>

<body>

<nav class="navbar navbar-expand-lg fixed-top bg-white border-bottom">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">SolarShare</a>
    <div class="d-flex align-items-center">
      <span class="small-muted me-3">Turn rooftops into renewable assets</span>
      <button class="btn btn-outline-success btn-sm" id="demoSample">Load Demo Data</button>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="row g-3">

    <div class="col-lg-4">

      <!-- Submission Card -->
      <div class="card p-3">
        <h5 class="mb-2">List Your Roof / Space</h5>
        <p class="form-note">Enter basic details — the platform will estimate suitability & CO₂ savings.</p>

        <form id="submitForm">
          <div class="mb-2"><label class="form-label">Name</label><input required id="ownerName" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Location</label><input required id="location" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Area (sq.ft)</label><input required type="number" id="area" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Sunlight hours/day</label><input required type="number" step="0.1" id="sunHours" class="form-control"></div>

          <div class="mb-2">
            <label class="form-label">Shade</label>
            <select id="shade" class="form-select">
              <option value="no">No</option>
              <option value="partial">Partial</option>
              <option value="yes">Yes</option>
            </select>
          </div>

          <div class="d-grid"><button class="btn btn-success">Submit</button></div>
        </form>

        <hr>
        <h6>Quick Tips</h6>
        <ul class="small-muted">
          <li>Flat, unshaded roofs are ideal</li>
          <li>100 sq.ft → 1.5 kW potential</li>
        </ul>
      </div>

      <!-- Marketplace -->
      <div class="card p-3 mt-3">
        <h6>Marketplace</h6>
        <div id="marketplaceList" style="max-height:220px;overflow:auto"></div>
      </div>

    </div>

    <!-- Right side -->
    <div class="col-lg-8">

      <div class="card p-3 mb-3">
        <h5>Map & Suitability</h5>
        <div id="map"></div>
      </div>

      <div class="row">
        <div class="col-md-6"><div class="card p-3 mb-3"><h6>Latest Submission</h6><div id="latestCard">No submissions yet</div></div></div>

        <div class="col-md-6"><div class="card p-3 mb-3"><h6>National Snapshot</h6><div class="small-muted">Total rooftops: <span id="totalCount">0</span></div><div class="small-muted mt-2">Total CO₂ saved</div><div class="h4" id="totalCO2">0 tCO₂</div></div></div>
      </div>

      <!-- Chart -->
      <div class="card p-3">
        <h6>CO₂ & Energy Estimate</h6>
        <canvas id="summaryChart" height="120"></canvas>
      </div>

    </div>
  </div>
</div>

<footer class="text-center py-3 muted">SolarShare — Demo Frontend</footer>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==============================
// CONFIG
// ==============================
let submissions = [];

// Your backend URL (NO TOKEN)
const API_URL = 'https://script.google.com/macros/s/AKfycbwILuCjdMHltVXr64gi33KtjESZPrz6E9m9oy0lm8LIhG6xuqiJiqqshQYoL45dzP4zEA/exec';

// ==============================
// UTIL FUNCTIONS
// ==============================
function areaToKW(a){ return Math.max(0.5, (a/100)*1.5); }
function annualKWh(kw, sun){ return Math.round(kw * sun * 365 * 0.75); }
function kWhToCO2(k){ return Math.round((k * 0.82)/1000 * 100)/100; }
function suitabilityScore(area,sun,shade){
  let s=50; s+=Math.min(30,sun*5); s+=Math.min(20,(area/100)*2);
  if(shade=='no')s+=10; if(shade=='yes')s-=15; return Math.max(0,Math.min(100,Math.round(s)));
}
function scoreLabel(score){
  if(score>=75)return{label:'High',color:'green'};
  if(score>=50)return{label:'Medium',color:'orange'};
  return{label:'Low',color:'red'};
}

// ==============================
// API FUNCTIONS
// ==============================
async function fetchSubmissions(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    if(data.success){
      submissions = data.data.map(normalizeRow);
      updateUI();
    }
  }catch(err){
    console.error("GET error:", err);
  }
}

async function postSubmission(entry){
  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(entry)
    });
    const data = await res.json();
    if(data.success){
      submissions.unshift(normalizeRow(data.data));
      updateUI();
      return true;
    }
  }catch(err){ console.error("POST error:", err); }
  return false;
}

function normalizeRow(r){
  return {
    owner: r.owner,
    location: r.location,
    area: Number(r.area),
    sunHours: Number(r.sunHours),
    shade: r.shade,
    kw: Number(r.kw),
    annual: Number(r.annual),
    co2: Number(r.co2),
    score: Number(r.score),
    timestamp: r.timestamp,
    lat: r.lat || null,
    lng: r.lng || null
  };
}

// ==============================
// MAP
// ==============================
const map = L.map('map').setView([20.5937,78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markerLayer = L.layerGroup().addTo(map);

function renderMarkers(){
  markerLayer.clearLayers();
  submissions.forEach(s=>{
    const color = scoreLabel(s.score).color;
    const m = L.circleMarker([s.lat || 20.5937, s.lng || 78.9629], {
      radius:10,color:color,fillOpacity:0.7
    }).addTo(markerLayer);
    m.bindPopup(`<b>${s.owner}</b><br>${s.location}<br>Score: ${s.score}`);
  });
}

// ==============================
// FORM
// ==============================
document.getElementById('submitForm').addEventListener('submit', async e=>{
  e.preventDefault();

  const owner = ownerName.value.trim();
  const location = location.value.trim();
  const area = Number(area.value);
  const sunHours = Number(sunHours.value);
  const shade = shade.value;

  const kw = areaToKW(area);
  const annual = annualKWh(kw, sunHours);
  const co2 = kWhToCO2(annual);
  const score = suitabilityScore(area, sunHours, shade);

  const entry = { owner, location, area, sunHours, shade, kw, annual, co2, score };

  const ok = await postSubmission(entry);
  if(!ok){ alert("Error saving."); }
  else { document.getElementById('submitForm').reset(); }
});

// ==============================
// UI UPDATE
// ==============================
function updateUI(){
  const latest = submissions[0];
  if(latest){
    const lbl = scoreLabel(latest.score);
    latestCard.innerHTML = `
      <div><strong>${latest.owner}</strong> — ${latest.location}</div>
      <div class="small-muted">Area: ${latest.area} sq.ft | Sun: ${latest.sunHours} hrs | Shade: ${latest.shade}</div>
      <div class="mt-2"><span class="chip">${lbl.label}</span> (${latest.score})</div>
      <div class="mt-2">Est kW: ${latest.kw} | CO₂: ${latest.co2} t/yr</div>
    `;
  }

  marketplaceList.innerHTML='';
  submissions.slice(0,20).forEach(s=>{
    const lbl = scoreLabel(s.score);
    const div = document.createElement("div");
    div.className="border p-2 mb-2 rounded";
    div.innerHTML=`
      <strong>${s.owner}</strong> <div class="small-muted">${s.location}</div>
      <span class="chip">${lbl.label}</span>
    `;
    marketplaceList.appendChild(div);
  });

  document.getElementById('totalCount').innerText = submissions.length;
  document.getElementById('totalCO2').innerText = submissions.reduce((t,x)=>t+x.co2,0).toFixed(2)+" tCO₂";

  renderMarkers();
  updateChart();
}

// ==============================
// CHART
// ==============================
const chartCtx = document.getElementById("summaryChart").getContext("2d");
const summaryChart = new Chart(chartCtx, {
  type: 'bar',
  data: { labels:[], datasets:[{ label:'Annual kWh', data:[] }] },
  options:{responsive:true,maintainAspectRatio:false}
});

function updateChart(){
  const data = submissions.slice(0,8);
  summaryChart.data.labels = data.map(s=>s.owner);
  summaryChart.data.datasets[0].data = data.map(s=>s.annual);
  summaryChart.update();
}

// ==============================
// INIT
// ==============================
fetchSubmissions();
updateUI();
</script>

</body>
</html>
