<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SolarShare — Simple</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{padding:20px;background:#f7faf7}</style>
</head>
<body>
  <div class="container" style="max-width:900px">
    <h3>SolarShare — List Your Roof</h3>
    <p class="text-muted">Enter rooftop details and the system will compute suitability, estimated energy, and CO₂ saved.</p>

    <form id="form" class="mb-3">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Name</label>
          <input id="owner" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Area (sq.ft)</label>
          <input id="area" type="number" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Location (city/pincode)</label>
          <input id="location" class="form-control" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Avg sun hours/day</label>
          <input id="sunHours" type="number" step="0.1" class="form-control" value="5.5">
        </div>
        <div class="col-md-4">
          <label class="form-label">Shade</label>
          <select id="shade" class="form-select">
            <option value="no">No</option>
            <option value="partial">Partial</option>
            <option value="yes">Yes</option>
          </select>
        </div>

        <div class="col-12">
          <button class="btn btn-success mt-2">Submit</button>
          <button type="button" id="load" class="btn btn-outline-primary mt-2 ms-2">Load Submissions</button>
        </div>
      </div>
    </form>

    <div id="message" class="mb-3"></div>

    <div id="list"></div>
  </div>

<script>
/* =======================
   CONFIG — REPLACE THESE
   ======================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbykomBYwCK1C_yjS49aTYnSxTLX3kzxwOSwlHu-zIlaFE0uvN6bdLe75oCgP0tvodFgPA/exec'; // e.g. https://script.google.com/macros/s/XXX/exec
const API_TOKEN = 'vinayak123'; // must match the TOKEN in Apps Script
/* ======================= */

function areaToKW(area){ return Math.max(0.5, (area/100)*1.5); }
function annualKWh(kw, sun){ return Math.round(kw * sun * 365 * 0.75); }
function kWhToCO2(kwh){ return Math.round((kwh * 0.82)/1000 * 100)/100; }
function score(area, sun, shade){ let s=50; s+=Math.min(30,sun*5); s+=Math.min(20,(area/100)*2); if(shade==='no') s+=10; if(shade==='yes') s-=15; return Math.max(0,Math.min(100,Math.round(s))); }

const form = document.getElementById('form');
const msg = document.getElementById('message');
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const owner = document.getElementById('owner').value.trim();
  const area = Number(document.getElementById('area').value);
  const location = document.getElementById('location').value.trim();
  const sunHours = Number(document.getElementById('sunHours').value);
  const shade = document.getElementById('shade').value;

  const kw = areaToKW(area);
  const annual = annualKWh(kw, sunHours);
  const co2 = kWhToCO2(annual);
  const sc = score(area, sunHours, shade);

  const payload = { owner, area, location, sunHours, shade, kw, annual, co2, score: sc };

  setMessage('Submitting...', 'info');
  try {
    const res = await fetch(API_URL + '?token=' + encodeURIComponent(API_TOKEN), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch(e) {
      const m = text.match(/({[\s\S]*})/);
      json = m ? JSON.parse(m[1]) : { success:false, error:'invalid_response' };
    }
    if(json && json.success){
      setMessage('Saved successfully ✅', 'success');
      load();
      form.reset();
    } else {
      setMessage('Error: ' + (json.error || 'unknown'), 'danger');
    }
  } catch(err) {
    setMessage('Submit failed: ' + err, 'danger');
  }
});

document.getElementById('load').addEventListener('click', load);

function setMessage(txt, kind){
  msg.innerHTML = `<div class="alert alert-${kind||'secondary'}">${txt}</div>`;
}

async function load(){
  setMessage('Loading...', 'info');
  try {
    const res = await fetch(API_URL + '?token=' + encodeURIComponent(API_TOKEN));
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch(e){
      const m = text.match(/({[\s\S]*})/);
      json = m ? JSON.parse(m[1]) : null;
    }
    if(!json || !json.success){
      setMessage('Failed to load data', 'danger'); return;
    }
    renderList(json.data || []);
    setMessage('Loaded ' + (json.data?json.data.length:0) + ' submissions', 'success');
  } catch(err){
    setMessage('Load failed: ' + err, 'danger');
  }
}

function renderList(rows){
  const container = document.getElementById('list');
  if(!rows || rows.length===0){ container.innerHTML = '<div class="text-muted">No submissions yet</div>'; return; }
  let html = '<table class="table table-sm"><thead><tr><th>Owner</th><th>Area</th><th>Location</th><th>Sun hrs</th><th>Shade</th><th>kW</th><th>Annual kWh</th><th>CO₂ t/yr</th><th>Score</th></tr></thead><tbody>';
  rows.forEach(r=>{
    html += `<tr>
      <td>${esc(r.owner)}</td>
      <td>${esc(r.area)}</td>
      <td>${esc(r.location)}</td>
      <td>${esc(r.sunHours)}</td>
      <td>${esc(r.shade)}</td>
      <td>${esc(r.kw)}</td>
      <td>${esc(r.annual)}</td>
      <td>${esc(r.co2)}</td>
      <td>${esc(r.score)}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function esc(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

// auto-load
// load();
</script>
</body>
</html>
